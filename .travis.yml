language: nix
nix: 2.1.3

install:
  - nix-env -iA cachix -f https://cachix.org/api/v1/install

before_install:
  - git lfs pull

script:
  - cachix authtoken "$CACHIX_AUTH_TOKEN" >/dev/null
  - cachix use urbit2

  - ./sh/cachix-local
  - ./sh/cachix-release

  - make
  - make release

  # make test
  # sh/update-brass-pill

deploy:
  - skip_cleanup: true
    provider: gcs
    access_key_id: GOOGTADOPP55X5ZTH3IKAXQW
    secret_access_key:
      secure: "VjA+nEfT6eqClZmmK17+SbVv55fBKt2OG61+oXG+CYgEYqUhX5f56EuCxmWkIiUMMnIcnkz3tSO2PVTbMrCKqucRppW4cZPZmj7VpJK0ttZGuYh4tYSGYcF5BAQsnwDo2jKLNDY0nYrvXPK8xLTIpKGJbt+z0dOQa1oydXRykhY="
    bucket: bootstrap.urbit.org
    local-dir: release/
    acl: public-read
    on:
      condition: "-d release/"
      repo: urbit/urbit
      all_branches: true

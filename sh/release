#!/usr/bin/env bash

set -e

err () { echo "$@" >&2; exit 1; }

[ $# = 2 ] || err "usage: $0 pkg host"

traced () {
  echo '$' "$@" >&2; "$@"
}

release () {
  traced nix-build nix/release.nix --no-out-link -A "$1"
}

pkg="$1"
env="$2"

res=$(release "$env.$pkg")

mkdir -p ./release/$env
traced cp -f $res/bin/$pkg ./release/$env/$pkg
traced cp -f $res/bin/$pkg-worker ./release/$env/$pkg-worker
traced cp -r $res/bin/$pkg-terminfo ./release/$env/$pkg-terminfo

chmod -R u+wr ./release/$env/$pkg-terminfo
